<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>



    <script src="scripts/jquery-2.1.4.js"></script>
    <script src="scripts/jquery-ui-1.11.4/jquery-ui.js"></script>
    <script src="scripts/MonthPicker.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>


    <link href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" media="all" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="css/MonthPicker.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/bootstrap-theme.css">

    <script>
        $(document).ready(function() {
//            $('.month-picker-input').MonthPicker(
//                    {
//                        Position : {at : "left+20 top+40"},
//                        OnAfterChooseMonth : function() {
//                            var selectedMonthYear = $(this).MonthPicker('GetSelectedMonthYear');
//                            $("#start_date").text(selectedMonthYear);
//                        }
//                    }
//            );


            String.prototype.format = String.prototype.format = function () {
                var args = arguments;
                return this.replace(/\{\{|\}\}|\{(\d+)\}/g, function (m, n) {
                    if (m == "{{") { return "{"; }
                    if (m == "}}") { return "}"; }
                    return args[n];
                });
            };

            var tabTemplate = '<li><a data-toggle="tab" href="#{0}">{1}<button class="close closeTab" type="button" >×</button></a></li>';
            var tabContentTemplate = '<div id="{0}" class="tab-pane fade">{1}</div>';

            var openedTabs = {};


            $(".dropdown-menu li a").click(function(event) {

                var reportId = $(this).attr("href").substring(1);
                var reportName = $(this).text();

                if(reportId in openedTabs) {
                    openedTabs[reportId].tab('show');
                } else {
                    var newTab = createTab(reportName, reportId);
                    setUpCloseEvent(newTab);
                    createTabContent(reportId);
                    openedTabs[reportId] = newTab;
                    newTab.tab('show');
                }
                event.preventDefault();
            });


            function createTab(tabName, contentId) {
                var tab = $(tabTemplate.format(contentId, tabName));
                tab.appendTo("#tabs");
                return tab.children("a");
            }

            function createTabContent(contentId) {
                //TODO по contentId сгенерировать контент (AJAX)
                var newTabContent = $(tabContentTemplate.format(contentId, "some text"));
                newTabContent.appendTo("#tab-content");
            }

            function setUpCloseEvent(tab) {
                tab.find(".closeTab").click(function() {
                    var reportId = $(this).parent().attr("href").substring(1);
                    $(this).parent().parent().remove();
                    $('#' + reportId).remove();
                    $('#tabs a:first').tab('show'); //TODO сюда прикрутить логику последней активной вкладки
                    delete openedTabs[reportId];
                });
            }
        });
    </script>


</head>
<body>
<div class="container">

    <div class="top-menu">
        <div class="dropdown">
            <button class="btn dropdown-toggle" type="button" data-toggle="dropdown">Выбрать отчет</button>
            <ul class="dropdown-menu">
                <li><a href="#report_1">Отчет 1</a></li>
                <li><a href="#report_2">Отчет 2</a></li>
                <li><a href="#report_3">Отчет 3</a></li>
            </ul>
        </div>

    </div>

    <ul class="nav nav-tabs" id="tabs"></ul>
    <div class="tab-content" id="tab-content"></div>

</div>
    <!--<input class='month-picker-hidden month-picker-input' type="text"  title="#"/>-->
</body>
</html>